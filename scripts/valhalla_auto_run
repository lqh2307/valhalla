#!/usr/bin/env python3

import subprocess
import argparse
import logging
import sys
import os

# Config logs
LOGGER = logging.getLogger(__name__)
handler = logging.StreamHandler()
handler.setFormatter(logging.Formatter("%(asctime)s %(levelname)5s: %(message)s"))
LOGGER.addHandler(handler)
LOGGER.setLevel(logging.INFO)

# Config args
parser = argparse.ArgumentParser(description="""Script to auto run valhalla.""")

parser.add_argument(
  "-i",
  "--input_osm_files",
  type=str,
  required=True,
  help="Input OSM osm.pbf file paths, separated by space"
)
parser.add_argument(
  "-e",
  "--elevation_bounding_box",
  type=str,
  default="96,4,120,28",
  help="Bounding box for elevation data (format: min_lon,min_lat,max_lon,max_lat)"
)
parser.add_argument(
  "-n",
  "--service_num_processes",
  type=int,
  default=1,
  help="Number of processes for the Valhalla service"
)
parser.add_argument(
  "-p",
  "--prefix",
  help="Prefix of path to the data folders.",
  type=Path,
  default="data",
)

def run_command(command):
  LOGGER.info(f"Running command {command}...")

  try:
    subprocess.run(command, check=True, shell=True)
  except Exception as e:
    LOGGER.error(f"Failed to run command {command}: {e}.")

    return False

  return True

if __name__ == "__main__":
  args = parser.parse_args()

  inputOSMPBFFilePath = " ".join([Path(f"{args.prefix}/osm/{file_name}") for file_name in os.listdir(Path(f"{args.prefix}/osm"))])
  config_file_path = Path(f"{args.prefix}/valhalla.json")

  # Auto run
  LOGGER.info(f"[1/7] ==========> Creating data folder...")
  res = run_command(f"valhalla_create_data_folders -p {args.prefix}")
  if not res:
    sys.exit(1)

  LOGGER.info(f"[2/7] ==========> Creating config file...")
  res = run_command(f"valhalla_create_config -p {args.prefix}")
  if not res:
    sys.exit(1)

  LOGGER.info(f"[3/7] ==========> Building landmarks using {inputOSMPBFFilePath}...")
  run_command(f"valhalla_build_landmarks -c {config_file_path} {inputOSMPBFFilePath}")

  LOGGER.info(f"[4/7] ==========> Building admins using {inputOSMPBFFilePath}...")
  run_command(f"valhalla_build_admins -c {config_file_path} {inputOSMPBFFilePath}")

  LOGGER.info(f"[5/7] ==========> Building tiles using {inputOSMPBFFilePath}...")
  res = run_command(f"valhalla_build_tiles -c {config_file_path} {inputOSMPBFFilePath}")
  if not res:
    sys.exit(1)

  LOGGER.info(f"[6/7] ==========> Building extract...")
  res = run_command(f"valhalla_build_extract -p {args.prefix}")
  if not res:
    sys.exit(1)

  LOGGER.info(f"[7/7] ==========> Starting service with {args.service_num_processes} processes...")
  res = run_command(f"valhalla_service {config_file_path} {args.service_num_processes}")
  if not res:
    sys.exit(1)
